<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Middlehand for Imaginary Female Visuals</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1f2937;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        --border-radius: 12px;
        --border-radius-lg: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        line-height: 1.6;
        color: var(--gray-700);
      }

      #main {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="a" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="200" cy="200" r="100" fill="url(%23a)"/><circle cx="800" cy="300" r="150" fill="url(%23a)"/><circle cx="400" cy="700" r="120" fill="url(%23a)"/></svg>');
        opacity: 0.3;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .header .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 400;
        position: relative;
        z-index: 1;
      }

      .content {
        padding: 40px;
      }

      .loading, .error {
        text-align: center;
        padding: 60px 20px;
        font-size: 1.1rem;
      }

      .loading {
        color: var(--gray-500);
        background: var(--gray-50);
        border-radius: var(--border-radius);
        border: 2px dashed var(--gray-200);
        margin: 20px 0;
      }

      .error {
        color: var(--danger);
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--border-radius);
        margin: 20px 0;
      }

      .controls-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 10px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--gray-100);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .control-group {
        position: relative;
      }

      .control-group label {
        display: block;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 8px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .control-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        background: white;
        font-size: 0.95rem;
        color: var(--gray-700);
        transition: all 0.2s ease;
        appearance: none;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        cursor: pointer;
      }

      .control-group select:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .control-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      }

      .workflow-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--gray-200);
      }

      .advanced-section {
        background: white;
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        overflow: hidden;
      }

      .advanced-header {
        padding: 2px 30px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .advanced-header:hover {
        background: var(--gray-50);
      }

      .advanced-header .section-title {
        margin: 0;
        border: none;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .advanced-subtitle {
        font-size: 0.9rem;
        color: var(--gray-500);
        font-weight: 400;
      }

      .toggle-icon {
        font-size: 1.2rem;
        color: var(--gray-400);
        transition: transform 0.3s ease;
        margin-left: 10px;
      }

      .toggle-icon.expanded {
        transform: rotate(180deg);
      }

      .advanced-content {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease, padding 0.4s ease;
        padding: 0 30px;
      }

      .advanced-content.expanded {
        max-height: 1000px;
        padding: 30px;
      }

      .advanced-content.collapsed {
        max-height: 0;
        padding: 0 30px;
      }

      .workflow-step {
        margin-bottom: 20px;
        text-align: center;
      }

      .workflow-step:last-child {
        margin-bottom: 0;
      }

      .step-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        font-size: 0.95rem;
        font-weight: 500;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: var(--shadow);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
        color: white;
        box-shadow: var(--shadow);
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
        box-shadow: var(--shadow);
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-warning {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
        box-shadow: var(--shadow);
      }

      .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .master-button-section {
        text-align: center;
        margin: 40px 0;
        position: relative;
      }

      .btn-master {
        font-size: 1.1rem;
        font-weight: 600;
        padding: 18px 40px;
        background: linear-gradient(135deg, var(--secondary) 0%, #be185d 100%);
        color: white;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .btn-master:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
      }

      .btn-master::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn-master:active::after {
        width: 300px;
        height: 300px;
      }

      .copy-indicator {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success);
        color: white;
        padding: 8px 16px;
        border-radius: var(--border-radius);
        font-size: 0.85rem;
        font-weight: 500;
        display: none;
        white-space: nowrap;
        box-shadow: var(--shadow);
        animation: fadeInOut 2s ease-in-out;
      }

      @keyframes fadeInOut {
        0%, 100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      }

      .copy-indicator::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border: 6px solid transparent;
        border-top-color: var(--success);
      }

      .output-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .output-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
      }

      .copy-status {
        color: var(--success);
        font-weight: 500;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        gap: 5px;
      }

      #promptBox {
        width: 100%;
        min-height: 250px;
        padding: 15px;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        resize: vertical;
        font-family: 'Inter', monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--gray-700);
        background: var(--gray-50);
        transition: border-color 0.2s ease;
      }

      #promptBox:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        background: white;
      }

      .emoji {
        font-size: 1.2em;
        margin-right: 4px;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }
        
        .content {
          padding: 20px;
        }
        
        .controls {
          grid-template-columns: 1fr;
        }
        
        .controls-section,
        .workflow-section,
        .output-section {
          padding: 20px;
        }
        
        .btn-master {
          padding: 16px 32px;
          font-size: 1rem;
        }
      }

      /* Animation for showing sections */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Loading animation */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-300);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="main">
      <div class="header">
        <h1>‚ú® Middlehand for Imaginary Female Visuals</h1>
        <div class="subtitle">Prompt Generator for creating descriptive Female T2I Prompts</div>
      </div>

      <div class="content">
        <div id="loadingMessage" class="loading">
          <div class="loading-spinner"></div>
          Loading data files...
        </div>
        <div id="errorMessage" class="error" style="display: none"></div>

        <!-- Master Button - Now at the top! -->
        <div class="master-button-section" id="masterSection" style="display: none">
          <button id="masterGenerateBtn" class="btn btn-master" title="Runs all steps in optimal order to build a high-quality, coherent image prompt and automatically copies it to clipboard.">
            <span class="emoji">‚ö°</span> Generate Prompt & Copy
          </button>
          <div id="masterCopyIndicator" class="copy-indicator">
            ‚úì Copied to Clipboard!
          </div>
        </div>

        <!-- Advanced Controls - Collapsible Section -->
        <div class="advanced-section fade-in" id="advancedSection">
          <div class="advanced-header" id="advancedToggle">
            <h2 class="section-title">
              <span class="emoji">üîß</span> Advanced Controls
              <span class="toggle-icon">‚ñº</span>
            </h2>
            <div class="advanced-subtitle">Manual step-by-step workflow for power users</div>
          </div>
          
          <div class="advanced-content" id="advancedContent">
            <div class="workflow-step">
              <div class="step-label">Step 1: Base Setup</div>
              <button id="randomBtn" class="btn btn-primary" title="Randomly fills all dropdowns for a fresh character setup.">
                <span class="emoji">üé≤</span> Randomize Prompt
              </button>
            </div>

            <div class="workflow-step">
              <div class="step-label">Step 2-3: Core Enhancement</div>
              <button id="refineBtn" class="btn btn-secondary" title="Adds category-specific visual detail for hair, clothing, body, etc.">
                <span class="emoji">üîß</span> Refine Details
              </button>
              <button id="styleMoodBtn" class="btn btn-secondary" title="Matches mood and lighting to your selected style for scene coherence.">
                <span class="emoji">üé®</span> Apply Style Matrix
              </button>
            </div>

            <div class="workflow-step">
              <div class="step-label">Step 4-5: Scene & Motion</div>
              <button id="detailBtn" class="btn btn-warning" title="Adds environmental or scene-based visual elements based on setting.">
                <span class="emoji">üåÑ</span> Expand Environment
              </button>
              <button id="boosterBtn" class="btn btn-warning" title="Adds one visual action or expression booster for realism or movement.">
                <span class="emoji">üé¨</span> Add Visual Booster
              </button>
            </div>

            <div class="workflow-step">
              <div class="step-label">Step 6: Final Assembly</div>
              <button id="structuredPromptBtn" class="btn btn-success" title="Generates the final structured prompt using all current inputs.">
                <span class="emoji">üõ†Ô∏è</span> Generate Structure
              </button>
            </div>

            <div class="workflow-step">
              <div class="step-label">Manual Copy</div>
              <button id="copyBtn" class="btn btn-success">
                <span class="emoji">üìã</span> Copy Current Prompt
              </button>
              <span id="copyStatus" class="copy-status">
                ‚úì Copied!
              </span>
            </div>
          </div>
        </div>

        <!-- Output Section - Now positioned after advanced controls -->
        <div class="output-section fade-in" id="outputSection" style="display: none">
          <div class="output-header">
            <h2 class="output-title">üìù Generated Prompt</h2>
          </div>
          <textarea id="promptBox" readonly placeholder="Your crafted Text 2 Image prompt will appear here..."></textarea>
        </div>

        <!-- Character Configuration - Now at the bottom -->
        <div class="controls-section fade-in" id="controlsSection" style="display: none">
          <h2 class="section-title">üé® Character Configuration</h2>
          <div class="controls" id="controls"></div>
        </div>
      </div>
    </div>

    <script>
      // [Original JavaScript code remains exactly the same - no functional changes]
      const orderedKeys = [
        "Subject",
        "Body Type",
        "Hair Style",
        "Hair Color",
        "Hair Accessories",
        "Clothing",
        "Common Accessories",
        "Mood",
        "Environment",
        "Lighting",
        "Style",
        "Camera",
      ];

      let data = {};
      let categoryRefiners = {};
      let matrix = {};
      let boosterSlots = {};

      async function loadAllData() {
        const files = [
          { name: "data.json", variable: "data" },
          { name: "categoryRefiners.json", variable: "categoryRefiners" },
          { name: "matrix.json", variable: "matrix" },
          { name: "boosterSlots.json", variable: "boosterSlots" },
        ];

        const results = await Promise.allSettled(
          files.map(async (file) => {
            try {
              const response = await fetch(file.name);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              const json = await response.json();
              return { file: file.name, variable: file.variable, data: json };
            } catch (error) {
              throw new Error(`${file.name}: ${error.message}`);
            }
          })
        );

        const failed = results.filter((result) => result.status === "rejected");
        if (failed.length > 0) {
          const errorMessages = failed.map((result) => result.reason.message).join("\n");
          throw new Error(`Failed to load files:\n${errorMessages}`);
        }

        results.forEach((result) => {
          const { variable, data: jsonData } = result.value;
          switch (variable) {
            case "data": data = jsonData; break;
            case "categoryRefiners": categoryRefiners = jsonData; break;
            case "matrix": matrix = jsonData; break;
            case "boosterSlots": boosterSlots = jsonData; break;
          }
        });
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.innerHTML = message.replace(/\n/g, "<br>");
        errorDiv.style.display = "block";
        document.getElementById("loadingMessage").style.display = "none";
      }

      function hideLoadingAndShowUI() {
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        
        // Show sections with staggered animation
        const sections = ['controlsSection', 'workflowSection', 'masterSection', 'outputSection'];
        sections.forEach((id, index) => {
          setTimeout(() => {
            document.getElementById(id).style.display = "block";
          }, index * 150);
        });
      }

      function initControls() {
        const controlsDiv = document.getElementById("controls");
        controlsDiv.innerHTML = "";

        orderedKeys.forEach((key) => {
          const idKey = key.replace(/\s/g, "") + "Select";
          const group = document.createElement("div");
          group.className = "control-group";
          group.innerHTML = `
            <label for="${idKey}">${key}</label>
            <select id="${idKey}"></select>
          `;
          controlsDiv.appendChild(group);

          const sel = group.querySelector("select");
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = `‚Äî select ${key} ‚Äî`;
          placeholder.disabled = true;
          placeholder.selected = true;
          sel.appendChild(placeholder);

          if (data[key]) {
            if (typeof data[key] === "object" && !Array.isArray(data[key])) {
              Object.keys(data[key]).forEach((label) => {
                const optgroup = document.createElement("optgroup");
                optgroup.label = label;
                if (Array.isArray(data[key][label])) {
                  data[key][label].forEach((opt) => {
                    const o = document.createElement("option");
                    o.value = opt;
                    o.textContent = opt;
                    optgroup.appendChild(o);
                  });
                }
                sel.appendChild(optgroup);
              });
            } else if (Array.isArray(data[key])) {
              data[key].forEach((opt) => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                sel.appendChild(o);
              });
            }
          }

          sel.addEventListener("change", updatePrompt);
        });

        updatePrompt();
      }

      function updatePrompt() {
        const parts = orderedKeys
          .map((key) => {
            const sel = document.getElementById(key.replace(/\s/g, "") + "Select");
            return sel ? sel.value : "";
          })
          .filter((val) => val && !/^-.+-$/.test(val));
        document.getElementById("promptBox").value = parts.join(", ");
      }

      function randomizePrompt() {
        orderedKeys.forEach((key) => {
          const select = document.getElementById(key.replace(/\s/g, "") + "Select");
          if (!select) return;

          if (key === "Hair Accessories" || key === "Common Accessories") {
            const milliseconds = new Date().getMilliseconds();
            if (key === "Hair Accessories" && milliseconds % 3 === 0) {
              select.value = "";
              return;
            } else if (key === "Common Accessories" && milliseconds % 5 === 0) {
              select.value = "";
              return;
            }
          }

          const options = Array.from(select.options).filter((o) => !o.disabled && o.value);
          if (options.length > 0) {
            const randomOption = options[Math.floor(Math.random() * options.length)];
            select.value = randomOption.value;
          }
        });
        updatePrompt();
      }

      function copyToClipboard(text, indicatorId = "copyStatus") {
        return navigator.clipboard.writeText(text)
          .then(() => {
            const indicator = document.getElementById(indicatorId);
            indicator.style.display = indicatorId === "masterCopyIndicator" ? "block" : "inline-flex";
            setTimeout(() => {
              indicator.style.display = "none";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            const indicator = document.getElementById(indicatorId);
            indicator.style.display = indicatorId === "masterCopyIndicator" ? "block" : "inline-flex";
            setTimeout(() => {
              indicator.style.display = "none";
            }, 2000);
          });
      }

      function getCategoryRefiner(category, value) {
        if (categoryRefiners[category] && categoryRefiners[category][value]) {
          const list = categoryRefiners[category][value];
          return list[Math.floor(Math.random() * list.length)];
        }
        return "";
      }

      function getStyleMoodLighting(promptText) {
        if (!matrix || Object.keys(matrix).length === 0) {
          return { mood: "", lighting: "" };
        }

        const lowerPrompt = promptText.toLowerCase();
        const key = Object.keys(matrix).find((styleKey) =>
          lowerPrompt.includes(styleKey.toLowerCase())
        );

        if (!key || !matrix[key]) return { mood: "", lighting: "" };

        const { moods = [], lighting = [] } = matrix[key];
        return {
          mood: moods.length > 0 ? moods[Math.floor(Math.random() * moods.length)] : "",
          lighting: lighting.length > 0 ? lighting[Math.floor(Math.random() * lighting.length)] : "",
        };
      }

      function cleanPhrasing(rawPrompt) {
        let result = rawPrompt;
        result = result.replace(/\bwith ([^,]+), with ([^,]+)/gi, "with $1 and $2");
        result = result.replace(/\bwearing ([^,]+), wearing ([^,]+)/gi, "wearing $1 and $2");
        result = result.replace(/,\s*$/, "");
        result = result.charAt(0).toUpperCase() + result.slice(1);
        if (!result.endsWith(".")) result += ".";
        return result;
      }

function fixArticles(text) {
  // Remove double articles like "A a woman" or "A an adult"
  return text.replace(/\b(A|An)\s+(a|an)\s+/gi, (match, first, second) => {
    const nextWord = text.substring(match.length).split(/\s+/)[0];
    const vowelStart = /^[aeiouAEIOU]/.test(nextWord);
    return vowelStart ? "An " : "A ";
  });
}

function buildPromptFromTemplate() {
  const getVal = (label) => {
    const select = document.getElementById(label.replace(/\s/g, "") + "Select");
    return select?.value || "";
  };

  const subject = getVal("Subject");
  const hair = getVal("Hair Style");
  const hairColor = getVal("Hair Color");
  const body = getVal("Body Type");
  const clothing = getVal("Clothing");
  const accessories = getVal("Common Accessories");
  const hairAccessories = getVal("Hair Accessories");
  const environment = getVal("Environment");
  const style = getVal("Style");
  const mood = getVal("Mood");
  const lighting = getVal("Lighting");
  const camera = getVal("Camera");

  const hairRefiner = getCategoryRefiner("Hair Style", hair);
  const clothingRefiner = getCategoryRefiner("Clothing", clothing);
  const accessoryRefiner = getCategoryRefiner("Common Accessories", accessories);
  const hairAccessoryRefiner = getCategoryRefiner("Hair Accessories", hairAccessories);
  const bodyRefiner = getCategoryRefiner("Body Type", body);
  const moodRefiner = getCategoryRefiner("Mood", mood);

  const matrixResult = getStyleMoodLighting(style || "");
  const finalMood = mood || matrixResult.mood;
  const finalLighting = lighting || matrixResult.lighting;

  const appearance = [hairColor, hair, hairRefiner, body, bodyRefiner, clothing, clothingRefiner]
    .filter(Boolean).join(", ");
  const adornment = [hairAccessories, hairAccessoryRefiner, accessories, accessoryRefiner]
    .filter(Boolean).join(", ");
  const scene = environment ? `standing in ${environment}` : "";
  const styleMoodLight = [style, finalMood, moodRefiner, finalLighting]
    .filter(Boolean).join(", ");

  // Clean subject to avoid double articles
  const cleanSubject = subject ? subject.replace(/^(a|an)\s+/i, "") : "woman";
  const firstWord = cleanSubject.split(/\s+/)[0];
  const vowelStart = /^[aeiouAEIOU]/.test(firstWord);
  const article = vowelStart ? "An" : "A";

  const structuredParts = [
    `${article} ${cleanSubject}`,
    appearance ? `${appearance}` : "",
    adornment ? `adorned with ${adornment}` : "",
    scene,
    styleMoodLight ? `in a ${styleMoodLight}` : "",
    camera,
  ].filter(Boolean);

  const rawPrompt = structuredParts.join(", ").replace(/\s+,/g, ",").trim();
  const cleanedPrompt = fixArticles(rawPrompt);
  return cleanPhrasing(cleanedPrompt);
}

      function refinePrompt() {
        const box = document.getElementById("promptBox");
        box.value = buildPromptFromTemplate();
        return box.value;
      }

      function applyStyleMoodMatrix() {
        const box = document.getElementById("promptBox");
        const current = box.value;

        if (!matrix || Object.keys(matrix).length === 0) return;

        const lowerPrompt = current.toLowerCase();
        const styleKey = Object.keys(matrix).find((k) =>
          lowerPrompt.includes(k.toLowerCase())
        );

        if (styleKey && matrix[styleKey]) {
          const { moods = [], lighting = [] } = matrix[styleKey];

          const hasMood = moods.some((m) => current.includes(m));
          if (!hasMood && moods.length > 0) {
            const randomMood = moods[Math.floor(Math.random() * moods.length)];
            box.value += `, ${randomMood}`;
          }

          const hasLighting = lighting.some((l) => current.includes(l));
          if (!hasLighting && lighting.length > 0) {
            const randomLighting = lighting[Math.floor(Math.random() * lighting.length)];
            box.value += `, ${randomLighting}`;
          }
        }
      }

      function expandDetails() {
        const box = document.getElementById("promptBox");
        const environmentDetails = [
          "with soft atmospheric depth",
          "surrounded by ambient environmental details",
          "with natural lighting effects",
        ];
        const detail = environmentDetails[Math.floor(Math.random() * environmentDetails.length)];
        if (!box.value.toLowerCase().includes(detail.toLowerCase())) {
          box.value += `, ${detail}`;
        }
      }

      function applyVisualBooster() {
        const box = document.getElementById("promptBox");
        const current = box.value.toLowerCase();
        let added = [];

        if (boosterSlots && Object.keys(boosterSlots).length > 0) {
          Object.entries(boosterSlots).forEach(([slot, options]) => {
            if (!Array.isArray(options)) return;

            const already = options.some((opt) => current.includes(opt.toLowerCase()));
            if (already) return;

            const available = options.filter((opt) => !current.includes(opt.toLowerCase()));
            if (available.length > 0) {
              const pick = available[Math.floor(Math.random() * available.length)];
              added.push(pick);
            }
          });
        }

        if (added.length > 0) {
          box.value += `, ${added.slice(0, 1).join(", ")}`;
        }
      }

function setupEventListeners() {
  document.getElementById("copyBtn").addEventListener("click", () => {
    copyToClipboard(document.getElementById("promptBox").value);
  });

  document.getElementById("randomBtn").addEventListener("click", randomizePrompt);
  document.getElementById("refineBtn").addEventListener("click", refinePrompt);
  document.getElementById("styleMoodBtn").addEventListener("click", applyStyleMoodMatrix);
  document.getElementById("detailBtn").addEventListener("click", expandDetails);
  document.getElementById("boosterBtn").addEventListener("click", applyVisualBooster);
  document.getElementById("structuredPromptBtn").addEventListener("click", () => {
    const box = document.getElementById("promptBox");
    box.value = buildPromptFromTemplate();
  });

  document.getElementById("masterGenerateBtn").addEventListener("click", () => {
    randomizePrompt();
    setTimeout(() => {
      refinePrompt();
      applyStyleMoodMatrix();
      expandDetails();
      applyVisualBooster();
      const finalPrompt = buildPromptFromTemplate();
      document.getElementById("promptBox").value = finalPrompt;
      copyToClipboard(finalPrompt, "masterCopyIndicator");
    }, 100);
  });

  // üîß FIX: toggle advanced section
  const toggle = document.getElementById("advancedToggle");
  const content = document.getElementById("advancedContent");
  const icon = toggle.querySelector(".toggle-icon");

  toggle.addEventListener("click", () => {
    const expanded = content.classList.contains("expanded");
    if (expanded) {
      content.classList.remove("expanded");
      content.classList.add("collapsed");
      icon.classList.remove("expanded");
    } else {
      content.classList.remove("collapsed");
      content.classList.add("expanded");
      icon.classList.add("expanded");
    }
  });
}


      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await loadAllData();
          hideLoadingAndShowUI();
          initControls();
          setupEventListeners();
        } catch (err) {
          console.error("Error loading JSON files:", err);
          showError(
            `Error loading data files: ${err.message}<br><br>Please make sure all JSON files (data.json, categoryRefiners.json, matrix.json, boosterSlots.json) are in the same directory as this HTML file.`
          );
        }
      });
    </script>
  </body>
</html>